---
title: "Updating police mortality numbers"
author: "Frank Edwards and Ryan Brown"
output: bookdown::pdf_document2()
editor: visual
execute:
  echo: false
  warning: false
abstract: "Police killings in the US have increased in recent years. We find that the trends in total deaths has increased, as has the tend in the number of Black, Latinx and White people killed by police. Using a Bayesian approach to period life tables, we find that risks of being killed by police are in line with prior estimates, and HAVE THEY CHANGED."
---

```{r}
library(tidyverse)
library(gridExtra)
library(seasonal)
library(forecast)
library(broom)
library(patchwork)
library(bsts)
library(tidybayes)
source("read_nat.R")
bsts_series<-readRDS("bsts_series.RDS")
options(mc.cores = parallel::detectCores())
theme_set(theme_bw())
```

# introduction

lit review here on persistent racial ineq. how stable are risks over time? upward? downward? have they changed since 2016? since 2020?

lit review on flurry of 2019-2024 scholarship

efforts have been directed at reform. how has police violence changed over time?

# methods

## Data

MPV: aggregates deaths from FE and WaPo, plus media sourced reports. Includes all deaths where police use of force caused the death. Describe causes briefly. On duty and off duty.

NVSS: total age / race / sex spec mortality for five year groups. change from bridged race to single race 6 in 2020. comp in appx. it looks fine. desccribe race / ethn method: aian, api, blk (h/nh), wht h, wht nh.

SEER for state pop comps for imputation.

## Missing data imputation

MICE on MPV for age/race/sex. describe missingness. includes decedent demographics and state-level racial pop comp as predictors. m=10. all results presented as means with standard errors computed from cross-imputation variance and intervals around means reported as 2SE.

MORE ON THIS. UPPING TO m=20. DO EDA ON IMPUTED. Missing race is more common in recent years of the data.

## Time series analysis of police killings

We evaluate change over time in the number of people killed by police using methods appropriate for univariate time series data. We rely on monthly counts of deaths caused by police use of force between January 2013 and February 2024 compiled by Mapping Police Violence, from which we construct a time series of all use of force deaths, and race/ethnicity specific time series for American Indian and Alaska Native, Asian and Pacific Islander, Black, Latinx, and White deaths.

ADD IN BSTS?

## Demographic models for mortality risk and changes in mortality risk

-   multiple decrement period life tables. 3-yr moving windows
-   sim risks with negbin models

# Results

HIGH LEVEL SUMMARY OF FINDINGS

## Time series

ADAPT FOR BSTS MODEL

```{r}
source("make_decomp_plot_bsts.R")

top<-p0
  
bottom<-(p1|p2|p3|p4|p5) + 
  plot_layout(guides = 'collect',
              axes = 'collect',
              axis_title = 'collect') 
top / bottom 
```

ADD CAUSALIMPACT results for post May 25, 2020.

# results: population-adjusted mortality risk

Below, we display estimates from period life tables estimated for each race/ethnicity and gender. These models fix levels of risk over the life course using empirical age-specific estimates of mortality risk, then simulating mortality rates over the life course by cause for a synthetic cohort. We compute life tables for a moving 3-year period to evaluate whether and how risks of being killed by police have changed by group between 2013 and 2024.

RUN THIS AS MOVING AVERAGE INSTEAD. 3-year pools, MA

MODEL FOR BETTER AGE SPEC

```{r}
source("lifetable.R")
source("make_multi_table.R")

## 3 year MA
## 2013-15, 14-16, ...
#13-15
lt1<-dat %>% 
  filter(year <= 2015) %>% 
  group_by(.imp, age, gender, race_ethn) %>% 
  summarize(pol_deaths = sum(pol_deaths),
            deaths = sum(deaths),
            population = sum(population)) %>% 
  ungroup() %>% 
  make_multi_table()%>% 
  mutate(period = 2015)
#14-16
lt2<-dat %>% 
  filter(year>=2014, 
         year<=2016)%>% 
  group_by(.imp, age, gender, race_ethn) %>% 
  summarize(pol_deaths = sum(pol_deaths),
            deaths = sum(deaths),
            population = sum(population)) %>% 
  ungroup() %>% 
  make_multi_table() %>% 
  mutate(period = 2016)
#15-17
lt3<-dat %>% 
  filter(year>=2015, 
         year<=2017)%>% 
  group_by(.imp, age, gender, race_ethn) %>% 
  summarize(pol_deaths = sum(pol_deaths),
            deaths = sum(deaths),
            population = sum(population)) %>% 
  ungroup() %>% 
  make_multi_table() %>% 
  mutate(period = 2017)
#16-18
lt4<-dat %>% 
  filter(year>=2016,
         year<=2018)%>% 
  group_by(.imp, age, gender, race_ethn) %>% 
  summarize(pol_deaths = sum(pol_deaths),
            deaths = sum(deaths),
            population = sum(population)) %>% 
  ungroup() %>% 
  make_multi_table() %>% 
  mutate(period = 2018)
#17-19
lt5<-dat %>% 
  filter(year>=2017,
         year<=2019)%>% 
  group_by(.imp, age, gender, race_ethn) %>% 
  summarize(pol_deaths = sum(pol_deaths),
            deaths = sum(deaths),
            population = sum(population)) %>% 
  ungroup() %>% 
  make_multi_table() %>% 
  mutate(period = 2019)
#18-20
lt6<-dat %>% 
  filter(year>=2018,
         year<=2020)%>% 
  group_by(.imp, age, gender, race_ethn) %>% 
  summarize(pol_deaths = sum(pol_deaths),
            deaths = sum(deaths),
            population = sum(population)) %>% 
  ungroup() %>% 
  make_multi_table() %>% 
  mutate(period = 2020)
#19-21
lt7<-dat %>% 
  filter(year>=2019,
         year<=2021)%>% 
  group_by(.imp, age, gender, race_ethn) %>% 
  summarize(pol_deaths = sum(pol_deaths),
            deaths = sum(deaths),
            population = sum(population)) %>% 
  ungroup() %>% 
  make_multi_table() %>% 
  mutate(period = 2021)
#20-22
lt8<-dat %>% 
  filter(year>=2020,
         year<=2022)%>% 
  group_by(.imp, age, gender, race_ethn) %>% 
  summarize(pol_deaths = sum(pol_deaths),
            deaths = sum(deaths),
            population = sum(population)) %>% 
  ungroup() %>% 
  make_multi_table() %>% 
  mutate(period = 2022)
#20-22
lt9<-dat %>% 
  filter(year>=2021,
         year<=2023)%>% 
  group_by(.imp, age, gender, race_ethn) %>% 
  summarize(pol_deaths = sum(pol_deaths),
            deaths = sum(deaths),
            population = sum(population)) %>% 
  ungroup() %>% 
  make_multi_table() %>% 
  mutate(period = 2023)

lt_full<-bind_rows(lt1, lt2, lt3, lt4,
                   lt5, lt6, lt7, lt8,
                   lt9)

lt_c<-lt_full %>% 
  filter(age==80) %>% 
  group_by(race_ethn, gender, 
           period) %>% 
  summarize(c_mn = mean(c_i),
            c_se = sd(c_i)/sqrt(max(lt_full$.imp)))

# # plot male age spec q_i
# ggplot(lt_full,
#        aes(x = age, y = q_i * 1e5,
#            group = .imp)) + 
#   geom_line() + 
#   facet_wrap(~race_ethn)    

# plot male c_i
ggplot(lt_c,
       aes(x = period,
           y = c_mn,
           ymin = c_mn - 2*c_se,
           ymax = c_mn + 2*c_se,
           color = race_ethn,
           fill = race_ethn)) + 
  geom_line() + 
  geom_ribbon(alpha = 0.5, color = NA) + 
  labs(subtitle = "Lifetime risk for moving 3-year windows, 2015 - 2023") + 
  scale_x_continuous(breaks = breaks_pretty()) + 
  facet_wrap(~gender, 
             scales = "free") + 
  labs(x = "Period",
       fill = "Race/ethnicity",
       color = "Race/ethnicity",
       y = "Cumulative mortality rate, age 85")
# male ci estimates - within CI from PNAS for each group

```

This seems like too little uncertainty to me. re-evaluating the viability of the prior sim method i've used to brute force the CI.

estimates are generally within the prior intervals. looks like upward trend for B/W/H m and for B/H F.

```{r}
lt_full_age<-lt_full %>% 
  group_by(age, gender, race_ethn, period) %>% 
  summarize(q_mn = mean(q_i * 1e5) ,
            q_sd = sd(q_i * 1e5),
            q_se = q_sd / sqrt(10))

ggplot(lt_full_age %>% 
         filter(gender == "Male"),
       aes(x = age, 
           color = period,
           group = period,
           y = q_mn,
           ymax = q_mn + 2*q_se,
           ymin = ifelse(q_mn - 2*q_se < 0, 0, 
                         q_mn - 2*q_se))) + 
  geom_line() + 
  facet_wrap(~race_ethn, nrow = 1) + 
  theme(legend.position = "bottom")
```

```{r}
ggplot(lt_full_age %>% 
         filter(gender == "Female"),
       aes(x = age, 
           color = period,
           fill = period,
           group = period,
           y = q_mn,
           ymax = q_mn + 2*q_se,
           ymin = ifelse(q_mn - 2*q_se < 0, 0, 
                         q_mn - 2*q_se))) + 
  geom_line() + 
  facet_wrap(~race_ethn, nrow = 1) + 
  theme(legend.position = "bottom")
```
